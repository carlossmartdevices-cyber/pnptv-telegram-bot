# API Security Documentation

## Autenticaci√≥n y Autorizaci√≥n

Este documento describe la estrategia de seguridad implementada en las rutas de la API, incluyendo autenticaci√≥n, validaci√≥n de datos y control de acceso.

## Middleware de Seguridad

### 1. Middleware de Autenticaci√≥n

#### `authenticateTelegramUser`
Valida datos de Telegram WebApp usando HMAC-SHA256 para prevenir suplantaci√≥n de identidad.

**Caracter√≠sticas:**
- Valida hash criptogr√°fico de initData
- Verifica que auth_date no sea mayor a 24 horas
- Previene ataques de clock skew (permite m√°ximo 5 minutos)
- Adjunta `req.telegramUser` con datos validados
- Verifica que userId en params/body coincida con usuario autenticado

**Uso:**
```javascript
app.get("/api/profile/:userId", authenticateTelegramUser, handler);
```

#### `authenticateWithToken`
Autenticaci√≥n basada en tokens de sesi√≥n (access tokens JWT).

**Caracter√≠sticas:**
- Valida Bearer token en header Authorization
- Verifica tokens contra sesiones activas en Firestore
- Soporta revocaci√≥n de sesiones
- Adjunta `req.telegramUser` con datos de sesi√≥n

**Uso:**
```javascript
app.post("/api/auth/logout", authenticateWithToken, handler);
```

#### `authenticateHybrid`
Autenticaci√≥n h√≠brida que intenta token primero y luego Telegram initData.

**Caracter√≠sticas:**
- Flexible para diferentes clientes
- Prioriza tokens de sesi√≥n
- Fallback a Telegram initData

**Uso:**
```javascript
app.get("/api/profile/:userId", authenticateHybrid, handler);
```

#### `requireAdmin`
Middleware que requiere privilegios de administrador.

**Caracter√≠sticas:**
- Debe usarse DESPU√âS de authenticateTelegramUser
- Verifica userId contra ADMIN_IDS en variables de entorno
- Registra intentos de acceso no autorizado

**Uso:**
```javascript
router.get("/plans", authenticateTelegramUser, requireAdmin, handler);
```

### 2. Middleware de Validaci√≥n

Todas las rutas implementan validaci√≥n exhaustiva usando `express-validator`.

#### Validaciones Implementadas:

- **validateUserId**: Valida formato de Telegram user ID (entero positivo)
- **validatePlanId**: Valida ID de plan (alfanum√©rico, guiones, guiones bajos)
- **validatePostId**: Valida ID de post
- **validateProfileUpdate**: Valida actualizaci√≥n de perfil (bio, ubicaci√≥n)
- **validatePlanCreate**: Valida creaci√≥n de plan (todos los campos requeridos)
- **validatePlanUpdate**: Valida actualizaci√≥n de plan (campos opcionales)
- **validatePostCreate**: Valida creaci√≥n de post (texto, media, ubicaci√≥n)
- **validatePostUpdate**: Valida actualizaci√≥n de post
- **validatePostDelete**: Valida eliminaci√≥n de post
- **validateNearbyRequest**: Valida solicitud de usuarios cercanos (lat/lng, radio)
- **validatePaymentCreate**: Valida creaci√≥n de pago

## Clasificaci√≥n de Rutas

### üü¢ Rutas P√∫blicas (Sin Autenticaci√≥n)

Estas rutas son accesibles sin autenticaci√≥n:

```
GET  /api/config/public          - Configuraci√≥n p√∫blica del cliente
GET  /api/monitoring/health      - Health check para monitoreo
GET  /                            - P√°gina principal de Mini App
GET  /nearby                      - Mini App de usuarios cercanos
```

**Seguridad:** Estas rutas no exponen informaci√≥n sensible y son necesarias para funcionalidad b√°sica.

### üü° Rutas Autenticadas (Usuario)

Requieren autenticaci√≥n de Telegram o token de sesi√≥n:

```
# Autenticaci√≥n
POST /api/auth/telegram-login     - Login con Telegram Widget
POST /api/auth/refresh            - Refrescar access token
POST /api/auth/logout             - Cerrar sesi√≥n (token)
POST /api/auth/logout-all         - Cerrar todas las sesiones (token)

# Perfil
GET  /api/profile/:userId         - Obtener perfil (auth + validation)
PUT  /api/profile/:userId         - Actualizar perfil (auth + validation)

# Mapa
POST /api/map/nearby              - Usuarios cercanos (auth + validation)

# Planes
GET  /api/plans                   - Listar planes activos

# Pagos
POST /api/payment/create          - Crear link de pago (auth + validation)

# Posts
POST   /api/posts                 - Crear post (auth + validation)
GET    /api/posts/feed            - Feed de posts
GET    /api/posts/user/:userId    - Posts de usuario
GET    /api/posts/nearby          - Posts cercanos (validation)
GET    /api/posts/:postId         - Obtener post (validation)
PUT    /api/posts/:postId         - Actualizar post (auth + validation)
DELETE /api/posts/:postId         - Eliminar post (auth + validation)
POST   /api/posts/:postId/like    - Like a post
GET    /api/posts/user/:userId/stats - Estad√≠sticas de posts

# Streaming (placeholder)
GET  /api/live/streams            - Listar streams en vivo
```

**Seguridad:**
- Validaci√≥n de identity mediante Telegram initData o session token
- Verificaci√≥n que userId en request coincide con usuario autenticado
- Sanitizaci√≥n de inputs para prevenir XSS/injection
- Rate limiting impl√≠cito v√≠a Telegram

### üî¥ Rutas de Administrador

Requieren autenticaci√≥n + privilegios de administrador:

```
# Admin - Gesti√≥n de Planes
GET    /api/admin/plans            - Todos los planes (auth + admin)
GET    /api/admin/plans/stats      - Estad√≠sticas de planes (auth + admin)
GET    /api/admin/plans/:id        - Plan espec√≠fico (auth + admin + validation)
POST   /api/admin/plans            - Crear plan (auth + admin + validation)
PUT    /api/admin/plans/:id        - Actualizar plan (auth + admin + validation)
DELETE /api/admin/plans/:id        - Eliminar plan (auth + admin + validation)
POST   /api/admin/plans/:id/activate - Reactivar plan (auth + admin + validation)

# Monitoring
GET  /api/monitoring/status           - Estado del sistema (auth + admin)
GET  /api/monitoring/sessions/stats   - Estad√≠sticas de sesiones (auth + admin)
POST /api/monitoring/sessions/cleanup - Limpieza de sesiones (auth + admin)
GET  /api/monitoring/security/webhook-audit - Audit log (auth + admin)
GET  /api/monitoring/rate-limiting/stats - Stats rate limit (auth + admin)
GET  /api/monitoring/alerts           - Alertas del sistema (auth + admin)
```

**Seguridad:**
- Doble capa: autenticaci√≥n + verificaci√≥n de admin
- ADMIN_IDS configurado en variables de entorno
- Logging de todas las acciones administrativas
- Validaci√≥n estricta de inputs

### üü£ Webhooks (Autenticaci√≥n Especial)

```
POST /epayco/confirmation         - Webhook de confirmaci√≥n de pago
POST /epayco/response             - Respuesta de pago
```

**Seguridad:**
- Validaci√≥n de signature de ePayco
- Rate limiting espec√≠fico para webhooks
- Registro de auditor√≠a de todas las solicitudes
- Validaci√≥n de IPs permitidas (recomendado configurar)

## Validaci√≥n de Datos

### Estrategia de Validaci√≥n

Todas las rutas implementan validaci√≥n en m√∫ltiples capas:

1. **Validaci√≥n de Tipo**: express-validator verifica tipos de datos
2. **Sanitizaci√≥n**: Limpieza de HTML/scripts maliciosos
3. **Rangos**: Validaci√≥n de rangos num√©ricos (lat/lng, precios, etc.)
4. **Formatos**: Regex para IDs, usernames, etc.
5. **Longitudes**: L√≠mites de caracteres para prevenir DoS

### Ejemplos de Validaci√≥n

#### User ID
```javascript
validateUserId: [
  param('userId')
    .trim()
    .matches(/^\d+$/)
    .isLength({ min: 1, max: 20 })
]
```

#### Ubicaci√≥n
```javascript
body('location.latitude')
  .isFloat({ min: -90, max: 90 })

body('location.longitude')
  .isFloat({ min: -180, max: 180 })
```

#### Bio de Perfil
```javascript
body('bio')
  .optional()
  .trim()
  .isLength({ max: 500 })
  .customSanitizer(value => value.replace(/<[^>]*>/g, ''))
```

## Prevenci√≥n de Vulnerabilidades

### ‚úÖ Implementado

1. **Prevenci√≥n de User ID Spoofing**
   - Validaci√≥n criptogr√°fica de Telegram initData
   - Verificaci√≥n que userId en request = userId autenticado

2. **Prevenci√≥n de XSS (Cross-Site Scripting)**
   - Sanitizaci√≥n de todos los inputs de texto
   - Remoci√≥n de tags HTML en campos de texto libre
   - Validaci√≥n de tipos de datos

3. **Prevenci√≥n de SQL/NoSQL Injection**
   - Validaci√≥n estricta de tipos
   - No se construyen queries din√°micas sin validaci√≥n
   - Uso de m√©todos seguros de Firestore

4. **Rate Limiting**
   - Webhook rate limiting implementado
   - L√≠mites de tama√±o de payload (100MB para uploads)
   - L√≠mites de cantidad de items en arrays

5. **Session Management**
   - Tokens JWT con expiraci√≥n
   - Refresh tokens rotatorios
   - Revocaci√≥n de sesiones
   - Limpieza autom√°tica de sesiones expiradas

6. **CORS Configurado**
   - Headers CORS apropiados
   - Manejo de preflight OPTIONS

### ‚ö†Ô∏è Recomendaciones Adicionales

1. **Rate Limiting Global**
   - Implementar rate limiting por IP para todas las rutas
   - Usar librer√≠as como `express-rate-limit`

2. **Helmet.js**
   - Agregar headers de seguridad HTTP
   - Prevenci√≥n de clickjacking, MIME sniffing, etc.

3. **Validaci√≥n de IPs para Webhooks**
   - Restringir webhooks de ePayco a IPs conocidas

4. **HTTPS Only**
   - Forzar HTTPS en producci√≥n
   - HSTS headers

5. **Input Size Limits**
   - L√≠mites m√°s estrictos en tama√±os de archivos seg√∫n tipo
   - Validaci√≥n de dimensiones de im√°genes

## Variables de Entorno Cr√≠ticas

Estas variables deben estar configuradas para seguridad completa:

```bash
# Autenticaci√≥n
TELEGRAM_TOKEN=              # Token del bot de Telegram
TELEGRAM_BOT_TOKEN=          # Alias del token

# Administradores (IDs separados por comas)
ADMIN_IDS=123456789,987654321

# Sesiones
SESSION_SECRET=              # Secret para firmar tokens JWT
ACCESS_TOKEN_EXPIRY=15m      # Expiraci√≥n de access tokens
REFRESH_TOKEN_EXPIRY=7d      # Expiraci√≥n de refresh tokens

# Firebase
FIREBASE_PROJECT_ID=
FIREBASE_PRIVATE_KEY=
FIREBASE_CLIENT_EMAIL=

# ePayco
EPAYCO_PUBLIC_KEY=
EPAYCO_PRIVATE_KEY=
EPAYCO_P_CUST_ID=
EPAYCO_P_KEY=
```

## Testing de Seguridad

### Tests Recomendados

1. **Test de Autenticaci√≥n**
   - Intentar acceder rutas protegidas sin auth
   - Intentar con tokens expirados
   - Intentar con initData inv√°lido o manipulado

2. **Test de Validaci√≥n**
   - Enviar datos con tipos incorrectos
   - Enviar datos fuera de rangos permitidos
   - Intentar XSS en campos de texto
   - Enviar arrays/objetos excesivamente grandes

3. **Test de Autorizaci√≥n**
   - Usuario no-admin intentando rutas de admin
   - Usuario intentando acceder datos de otro usuario

4. **Test de Rate Limiting**
   - Flood de requests a webhooks
   - Verificar l√≠mites de payload

## Monitoreo y Logging

### Eventos Registrados

- ‚úÖ Autenticaci√≥n exitosa/fallida
- ‚úÖ Intentos de acceso no autorizado a rutas de admin
- ‚úÖ Errores de validaci√≥n (con detalles sanitizados)
- ‚úÖ Acciones administrativas (crear/modificar/eliminar planes)
- ‚úÖ Webhooks recibidos (para auditor√≠a de pagos)

### Alertas Configuradas

El endpoint `/api/monitoring/alerts` detecta:
- Uso excesivo de memoria (>75% warning, >90% critical)
- Sesiones expiradas acumuladas (>500)
- Variables de entorno cr√≠ticas faltantes

## Conclusi√≥n

La API implementa seguridad en profundidad con:
- ‚úÖ Autenticaci√≥n robusta (Telegram + JWT)
- ‚úÖ Validaci√≥n exhaustiva de inputs
- ‚úÖ Control de acceso basado en roles
- ‚úÖ Sanitizaci√≥n contra XSS
- ‚úÖ Logging y auditor√≠a
- ‚úÖ Session management seguro

Todas las rutas sensibles est√°n protegidas y validadas. La superficie de ataque ha sido minimizada significativamente.
