# ============================================
# SECURITY & MONITORING CONFIGURATION
# ============================================
# New environment variables for enhanced security features

# ============================================
# Session Management (Firestore Migration)
# ============================================
# Sessions are now stored in Firestore instead of sessions.json
# No additional configuration needed - automatically uses Firestore

# ============================================
# Webhook Security
# ============================================

# Strict signature validation mode
# Set to "false" in development to allow unsigned webhooks for testing
# MUST be "true" (or omitted) in production
EPAYCO_STRICT_SIGNATURE_MODE=true

# Optional: Whitelist ePayco webhook IPs (comma-separated)
# Contact ePayco support to get their current webhook IP addresses
# Example: EPAYCO_WEBHOOK_IPS=192.168.1.1,192.168.1.2,192.168.1.3
EPAYCO_WEBHOOK_IPS=

# ============================================
# Rate Limiting
# ============================================
# Webhook rate limiting is automatically enabled with these defaults:
# - 100 requests per minute per IP
# - 60 second sliding window
# - Automatic cleanup every 5 minutes
# No configuration needed - works out of the box

# ============================================
# Session Cleanup
# ============================================
# Automatic session cleanup runs every 6 hours
# Removes sessions older than 30 days
# No configuration needed - works out of the box

# ============================================
# Monitoring & Alerts
# ============================================
# New monitoring endpoints available:
# - GET /api/monitoring/health          (public - uptime check)
# - GET /api/monitoring/status          (admin - full system status)
# - GET /api/monitoring/sessions/stats  (admin - session statistics)
# - POST /api/monitoring/sessions/cleanup (admin - manual cleanup trigger)
# - GET /api/monitoring/security/webhook-audit (admin - webhook logs)
# - GET /api/monitoring/rate-limiting/stats (admin - rate limit stats)
# - GET /api/monitoring/alerts          (admin - system alerts)

# ============================================
# DEPLOYMENT CHECKLIST
# ============================================
# Before deploying to production:
#
# [ ] Set EPAYCO_STRICT_SIGNATURE_MODE=true
# [ ] Configure EPAYCO_WEBHOOK_IPS if available
# [ ] Enable webhook signatures in ePayco dashboard
# [ ] Test webhook with signature validation
# [ ] Monitor /api/monitoring/alerts for issues
# [ ] Set up external uptime monitoring for /api/monitoring/health
# [ ] Configure alerting for webhook failures
# [ ] Test rate limiting with load testing tool
# [ ] Verify session cleanup is running (check logs)
# [ ] Review security audit log regularly

# ============================================
# MIGRATION NOTES
# ============================================
#
# Firestore Sessions:
# - Sessions automatically migrated from sessions.json to Firestore
# - Old sessions.json file can be kept as backup
# - Sessions will auto-populate in Firestore on first bot interaction
# - Run: curl http://localhost:3000/api/monitoring/sessions/stats to check migration
#
# Webhook Security:
# - Webhooks now validate signatures by default
# - Set EPAYCO_STRICT_SIGNATURE_MODE=false for development testing
# - Monitor logs for "[WEBHOOK SECURITY]" messages
#
# Rate Limiting:
# - Automatically protects webhook endpoints
# - Check stats: curl -H "..." http://localhost:3000/api/monitoring/rate-limiting/stats
#
# Session Cleanup:
# - Runs automatically every 6 hours
# - Manual trigger: curl -X POST -H "..." http://localhost:3000/api/monitoring/sessions/cleanup

# ============================================
# TROUBLESHOOTING
# ============================================
#
# Issue: Webhooks being rejected
# Solution: Check if EPAYCO_STRICT_SIGNATURE_MODE is set correctly
#          Review logs for "[WEBHOOK SECURITY] Invalid signature"
#
# Issue: Rate limiting blocking legitimate requests
# Solution: Check rate limiter stats via monitoring endpoint
#          Increase limits in src/web/middleware/webhookRateLimit.js if needed
#
# Issue: High memory usage
# Solution: Check /api/monitoring/alerts for warnings
#          Run manual session cleanup if needed
#
# Issue: Sessions not persisting
# Solution: Verify Firebase credentials are correct
#          Check Firestore collection "bot_sessions" exists
#
# For more help, check the logs or create an issue on GitHub
