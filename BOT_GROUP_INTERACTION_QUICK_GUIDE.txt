# ğŸ¤– HOW THE BOT WORKS IN GROUPS - Quick Guide

## ğŸ¯ Main Interactions

### 1. NEW MEMBER JOINS
```
âœ… Applies permission tier (Free vs Premium)
âœ… Sends welcome message (auto-deletes 60s)
âœ… Logs to Firestore
```

### 2. USER RUNS COMMAND IN GROUP

**GROUP-ONLY COMMANDS** (Stay in group):
```
/menu, /library, /toptracks, /schedulecall, /upcoming, /settimezone
â†“
Response stays in group (auto-delete after 5 min)
```

**PRIVATE COMMANDS** (Go to DM):
```
/profile, /subscribe, /admin, /aichat, /help, /start
â†“
Response sent to private chat
Group sees: "âœ‰ï¸ @username, I've sent you a message... [ğŸ’¬ Check]"
(auto-delete after 5 min)
```

### 3. USER SENDS MEDIA (PHOTO/VIDEO)

**FREE TIER:**
```
âŒ Message deleted immediately
âš ï¸ Bot sends: "Hey @username! Only premium can send media.
   ğŸ’ Want to upgrade? â†’ /subscribe"
(warning auto-deletes 20s)
```

**PREMIUM TIER:**
```
âœ… Message allowed
âœ“ No action taken
```

### 4. BOT SENDS MESSAGE IN GROUP

```
Message appears
â†“ (5 minutes)
Auto-delete middleware
â†“
Message disappears

(Exception: Event notifications stay longer)
```

---

## ğŸ“Š Permission System

| Action | FREE | PREMIUM |
|--------|------|---------|
| Send text messages | âœ… | âœ… |
| Send photos | âŒ | âœ… |
| Send videos | âŒ | âœ… |
| Send documents | âŒ | âœ… |
| Send audio | âŒ | âœ… |
| Send voice notes | âŒ | âœ… |
| Send polls | âŒ | âœ… |
| Send stickers/GIFs | âŒ | âœ… |
| View music library | âœ… | âœ… |
| Create Zoom rooms | âŒ | âœ… |

---

## ğŸ“‹ Files Involved

| File | Purpose |
|------|---------|
| `privateResponseMiddleware.js` | Redirects private commands to DM |
| `autoDeleteMiddleware.js` | Deletes bot messages after 5 min |
| `groupManagement.js` | Permission checks, welcome messages |
| `groupMenu.js` | /menu handler and callbacks |
| `autoDeleteUserCommandsMiddleware.js` | Deletes user commands after 10s |

---

## ğŸ”„ Flow Example

### User runs /profile in group:

```
User types: /profile

â†“ (Group chat)

privateResponseMiddleware detects:
  â€¢ This is a group
  â€¢ /profile is private-only command

â†“ (Split action)

ACTION 1: Private Chat
  Send profile to user's DM

ACTION 2: Group Chat
  Send notification with button

â†“ (What group sees)

âœ‰ï¸ @username, I've sent you the response via private message.

[ğŸ’¬ Check Private Message]

â†“ (After 5 minutes)

autoDeleteMiddleware deletes notification

â†“ (After 10 seconds)

autoDeleteUserCommandsMiddleware deletes user's /profile command
```

---

## ğŸ’¡ Key Features

âœ… **Smart routing** - Private content goes to DM  
âœ… **Clean groups** - Auto-delete after 5 min  
âœ… **Permission enforcement** - Tier-based media restrictions  
âœ… **User feedback** - Warnings and notifications  
âœ… **Activity tracking** - Logs to Firestore  
âœ… **User mentions** - @username in notifications  
âœ… **Quick access** - "Check Private Message" button  
âœ… **Bilingual** - English & Spanish  

---

## ğŸ¯ Command Categories

### STAYS IN GROUP
- `/menu` - Group menu
- `/library` - Music library
- `/toptracks` - Top songs
- `/schedulecall` - Schedule video
- `/schedulestream` - Schedule stream
- `/upcoming` - Upcoming events
- `/settimezone` - Set timezone

### GOES TO DM
- `/start` - Onboarding
- `/help` - Help menu
- `/profile` - User profile
- `/subscribe` - Subscription
- `/admin` - Admin panel
- `/aichat` - AI chat
- `/map` - Location map
- `/nearby` - Find members

---

## âš™ï¸ Middleware Stack (Order of Execution)

```
1. privateResponseMiddleware
   â””â”€ Redirects private commands to DM

2. autoDeleteMiddleware
   â””â”€ Schedules 5-min deletion

3. autoDeleteUserCommandsMiddleware
   â””â”€ Deletes user messages after 10s

4. moderationMiddleware
   â””â”€ Checks blacklist

5. rateLimitMiddleware
   â””â”€ Max 20 req/min per user

â†“

Handler (groupManagement, groupMenu, etc.)
```

---

## ğŸ“± Timeline Example

**Scenario: User asks /profile in group at 2:00 PM**

```
2:00:00  User types /profile
2:00:01  Bot processes
2:00:02  DM sent with profile info
2:00:03  Group shows notification + button
2:00:10  User's /profile command deleted
2:05:03  Group notification deleted
2:05:04  Group is clean again
```

---

## ğŸ” Privacy & Security

âœ… User profiles â†’ DM only (not in group)  
âœ… Admin functions â†’ DM only (restricted access)  
âœ… Subscriptions â†’ DM only (sensitive data)  
âœ… Auto-delete â†’ Reduces data retention  
âœ… Rate limiting â†’ Prevents spam  
âœ… Moderation â†’ Blacklist checks  

---

## ğŸ“Š Current State

| Aspect | Status |
|--------|--------|
| Group message routing | âœ… Working |
| Permission system | âœ… Working |
| Auto-delete | âœ… Working |
| User mentions | âœ… Working (new) |
| Quick access button | âœ… Working (new) |
| Welcome messages | âœ… Working |
| Activity tracking | âœ… Working |
| Bilingual support | âœ… Working |

---

## ğŸ¯ Areas for Improvement

1. Better media rejection feedback
2. Group-wide announcements
3. Group activity stats
4. Admin controls per group
5. Interactive group features (polls, contests)
6. Better error messages
7. Custom deletion timers
8. Group achievements

---

For details, see: **BOT_GROUP_INTERACTION_ANALYSIS.md**
